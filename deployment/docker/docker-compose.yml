# Telegram Sales Agent - Docker Compose Stack
#
# PREREQUISITES:
#   1. Create .env file in project root with required variables:
#      - CLAUDE_CODE_OAUTH_TOKEN=your_oauth_token (from Claude Pro/Max subscription)
#      - POSTGRES_PASSWORD=your_password (for database)
#   2. Ensure Telegram credentials exist in ~/.telegram_dl/
#   3. (Optional) Configure Zoom credentials in ~/.zoom_credentials/
#
# USAGE:
#   - Start stack:   docker-compose -f deployment/docker/docker-compose.yml up -d
#   - Stop stack:    docker-compose -f deployment/docker/docker-compose.yml down
#   - View logs:     docker-compose -f deployment/docker/docker-compose.yml logs -f telegram-agent
#   - Restart agent: docker-compose -f deployment/docker/docker-compose.yml restart telegram-agent
#
# NOTES:
#   - Database data persists in postgres_data volume
#   - Telegram credentials are mounted read-only from host
#   - DATABASE_URL is automatically configured to use postgres service
#   - Agent will auto-restart on failure
#

services:
  # ==========================================================================
  # PostgreSQL Database
  # ==========================================================================
  # Stores scheduled actions and other persistent data for the Telegram agent.
  # Uses PostgreSQL 16 Alpine for a lightweight, production-ready database.
  postgres:
    image: postgres:16-alpine
    container_name: telegram-agent-db
    environment:
      POSTGRES_USER: sales_agent
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      POSTGRES_DB: sales_agent
    volumes:
      # Persistent data volume - survives container restarts
      - postgres_data:/var/lib/postgresql/data
      # Mount migrations for initialization (optional, run manually if needed)
      - ../../src/telegram_sales_bot/database/migrations:/docker-entrypoint-initdb.d:ro
    ports:
      # Expose PostgreSQL port for debugging/development
      # Remove or comment out in production for security
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sales_agent -d sales_agent"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - telegram-agent-network

  # ==========================================================================
  # Telegram Agent Daemon
  # ==========================================================================
  # Long-running service that handles prospect outreach and conversations.
  # Integrates with Claude AI for natural language processing and
  # PostgreSQL for scheduled action persistence.
  telegram-agent:
    build:
      context: ../..
      dockerfile: deployment/docker/Dockerfile
    container_name: telegram-agent
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Database connection (points to postgres service within Docker network)
      DATABASE_URL: postgresql://sales_agent:${POSTGRES_PASSWORD:-changeme}@postgres:5432/sales_agent
      # Timezone for scheduling (Bali/Indonesia)
      TZ: Asia/Makassar
      # Claude Code CLI authentication (OAuth token from Claude Pro/Max subscription)
      # Loaded via env_file from .env - do NOT override here (host env would clobber)
      # Unset ANTHROPIC_API_KEY so Claude CLI uses OAuth token instead of API credits
      ANTHROPIC_API_KEY: ""
      # Per-rep mode (optional)
      # Set to Telegram ID of registered sales rep to run daemon for specific rep
      # Leave empty or unset to use default mode (user.session)
      REP_TELEGRAM_ID: ${REP_TELEGRAM_ID:-}
    env_file:
      # Load additional environment variables from project root .env
      # Includes: CLAUDE_CODE_OAUTH_TOKEN, LOG_LEVEL, etc.
      - ../../.env
    volumes:
      # Mount Telegram credentials (required for Telethon authentication)
      # Note: Needs read-write access because Telethon updates the session file
      - ${HOME}/.telegram_dl:/home/agent/.telegram_dl:rw
      # Mount Zoom credentials (optional, for Zoom meeting scheduling)
      - ${HOME}/.zoom_credentials:/home/agent/.zoom_credentials:ro
      # Mount sales registry for per-rep calendar tokens (optional)
      - ${HOME}/.sales_registry:/home/agent/.sales_registry:ro
      # Mount Google Calendar credentials (optional, for calendar integration)
      - ../../.claude/skills/google-calendar/accounts:/app/.claude/skills/google-calendar/accounts:ro
      # Mount config directory (for prospects.json and agent_config.json) - needs read-write
      - ../../.claude/skills/telegram/config:/app/config:rw
    command: >
      sh -c "if [ -n \"$$REP_TELEGRAM_ID\" ]; then
        python -m telegram_sales_bot.core.daemon --rep-telegram-id $$REP_TELEGRAM_ID;
      else
        python -m telegram_sales_bot.core.daemon;
      fi"
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        # Limit log file size to prevent disk space issues
        max-size: "10m"
        max-file: "3"
    networks:
      - telegram-agent-network

  # ==========================================================================
  # Sales Representative Registry Bot
  # ==========================================================================
  # Telegram bot for sales rep registration and management.
  # Handles conversational registration flow and stores reps in database.
  registry-bot:
    build:
      context: ../..
      dockerfile: deployment/docker/Dockerfile.registry
    container_name: registry-bot
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Database connection (points to postgres service within Docker network)
      DATABASE_URL: postgresql://sales_agent:${POSTGRES_PASSWORD:-changeme}@postgres:5432/sales_agent
      # Registry bot Telegram token
      REGISTRY_BOT_TOKEN: ${REGISTRY_BOT_TOKEN}
      # Corporate email domain for validation
      CORPORATE_EMAIL_DOMAIN: ${CORPORATE_EMAIL_DOMAIN:-truerealestate.bali}
      # Timezone for scheduling (Bali/Indonesia)
      TZ: Asia/Makassar
    env_file:
      # Load additional environment variables from project root .env
      - ../../.env
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - telegram-agent-network

  # ==========================================================================
  # Outreach Daemon
  # ==========================================================================
  # Background daemon for proactive prospect assignment.
  # Assigns unreached prospects to active reps and sends notifications.
  outreach-daemon:
    build:
      context: ../..
      dockerfile: deployment/docker/Dockerfile.outreach
    container_name: outreach-daemon
    depends_on:
      postgres:
        condition: service_healthy
      registry-bot:
        condition: service_started
    environment:
      # Database connection (points to postgres service within Docker network)
      DATABASE_URL: postgresql://sales_agent:${POSTGRES_PASSWORD:-changeme}@postgres:5432/sales_agent
      # Registry bot token for sending notifications
      REGISTRY_BOT_TOKEN: ${REGISTRY_BOT_TOKEN}
      # Interval between assignment checks (in seconds)
      OUTREACH_INTERVAL_SECONDS: ${OUTREACH_INTERVAL_SECONDS:-300}
      # Maximum prospects to assign to one rep
      MAX_PROSPECTS_PER_REP: ${MAX_PROSPECTS_PER_REP:-5}
      # Enable/disable outreach daemon (set to false to disable)
      OUTREACH_ENABLED: ${OUTREACH_ENABLED:-true}
      # Timezone for scheduling (Bali/Indonesia)
      TZ: Asia/Makassar
    env_file:
      # Load additional environment variables from project root .env
      - ../../.env
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - telegram-agent-network

# =============================================================================
# Networks
# =============================================================================
networks:
  telegram-agent-network:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  # Persistent PostgreSQL data storage
  postgres_data:
    driver: local
